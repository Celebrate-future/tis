{
 "success":true,
 "errormsg":[],
 "msg":[],
 "bizresult":{
    "dumpNodes":[
        {
            "dbid":"58",
            "extraSql":"SELECT totalpay_id,curr_date,outfee,source_amount,discount_amount,result_amount,recieve_amount,ratio,status,entity_id,is_valid,create_time,op_time,last_ver,op_user_id,discount_plan_id,operator,operate_date,card_id,card,card_entity_id,is_full_ratio,is_minconsume_ratio,is_servicefee_ratio,invoice_code,invoice_memo,invoice,over_status,is_hide,load_time,modify_time,printnum1,printnum2,coupon_discount,ext,discount_amount_receivables,result_amount_receivables\nFROM totalpayinfo",
            "id":"683deaa9-92c6-0022-1d27-40ba500077e5",
            "name":"totalpayinfo",
            "position":{
                "x":770,
                "y":116
            },
            "tabid":"56",
            "type":"join"
        },
        {
            "dbid":"58",
            "extraSql":"SELECT order_id,global_code,simple_code,seat_code,code,curr_date,totalpay_id,seat_id,people_count,open_time,status,memo,inner_code,menutime_id,worker_id,end_time,feeplan_id,op_user_id,order_from,order_kind,area_id,name,mobile,tel,is_autocommit,send_time,address,paymode,outfee,sender_id,customerregister_id,waitingorder_id,send_status,audit_status,is_hide,entity_id,is_valid,create_time,op_time,last_ver,load_time,modify_time,is_limittime,scan_url,seat_mark,reservetime_id,is_wait,is_print,book_id,reserve_id,orign_id,reserve_status,ext\nFROM orderdetail",
            "id":"d56d4423-33dc-2adc-c5a8-e26df611df77",
            "name":"orderdetail",
            "position":{
                "x":324,
                "y":108
            },
            "tabid":"57",
            "type":"join"
        },
        {
            "dbid":"58",
            "extraSql":"SELECT id,order_id,status,paid_fee,outfee,origin_amount,origin_service_charge,origin_least_amount,agio_amount,agio_service_charge,agio_least_amount,origin_receivables_amount,agio_receivables_amount,entity_id,ext,is_valid,agio_total,last_ver,op_user_id,reserve_amount,origin_total,final_amount,use_cash_promotion,create_time,modify_time,op_time,load_time,agio_total_receivables,agio_receivables_amount_receivables,final_amount_receivables\nFROM order_bill",
            "id":"e6c9be82-d622-4e0f-db4e-f94df75518f3",
            "name":"order_bill",
            "position":{
                "x":431,
                "y":104
            },
            "tabid":"58",
            "type":"join"
        },
        {
            "dbid":"58",
            "extraSql":"SELECT specialfee_id,totalpay_id,order_id,kind,feedetail_id,fee,entity_id,is_valid,create_time,op_time,last_ver,op_user_id,load_time,modify_time\nFROM specialfee",
            "id":"a240c9ca-93da-6e79-6712-c7d2de4f2629",
            "name":"specialfee",
            "position":{
                "x":629,
                "y":113
            },
            "tabid":"59",
            "type":"join"
        },
        {
            "dbid":"58",
            "extraSql":"SELECT instance_id,order_id,batch_msg,type,ext,waitinginstance_id,kind,parent_id,pricemode,name,makename,taste,spec_detail_name,num,account_num,unit,account_unit,price,member_price,fee,ratio,ratio_fee,ratio_cause,status,kindmenu_id,kindmenu_name,menu_id,memo,is_ratio,entity_id,is_valid,create_time,op_time,last_ver,load_time,modify_time,draw_status,bookmenu_id,make_id,make_price,prodplan_id,is_wait,specdetail_id,specdetail_price,makeprice_mode,original_price,is_buynumber_changed,ratio_operator_id,child_id,kind_bookmenu_id,specprice_mode,worker_id,is_backauth,service_fee_mode,service_fee,orign_id,addition_price,has_addition,seat_id\nFROM instancedetail",
            "id":"f9e4a170-3f57-d541-b27e-b089ebf1ba75",
            "name":"instancedetail",
            "position":{
                "x":546,
                "y":109
            },
            "tabid":"62",
            "type":"join"
        },
        {
            "dbid":"58",
            "extraSql":"SELECT pay_id,totalpay_id,kindpay_id,kindpayname,fee,operator,operator_name,pay_time,pay,charge,is_valid,entity_id,create_time,op_time,last_ver,opuser_id,card_id,card_entity_id,online_bill_id,type,code,waitingpay_id,load_time,modify_time,is_dealed,type_name,coupon_fee,coupon_cost,coupon_num,ext,pay_from,parent_entity_id,parent_id,parent_code\nFROM payinfo",
            "id":"e0245cb9-2e84-55b2-4e6f-f8c88bba4316",
            "name":"payinfo",
            "position":{
                "x":696,
                "y":113
            },
            "tabid":"63",
            "type":"join"
        },
        {
            "dbid":"61",
            "extraSql":"SELECT id,kind_card_id,customer_id,code,inner_code,pwd,pay,active_date,pre_fee,balance,gift_balance,real_balance,degree,pay_amount,consume_amount,ratio_amount,status,get_status,active_id,entity_id,is_valid,create_time,op_time,last_ver,seller_id,last_consume_time,consume_num,extend_fields,kind_card_type,give_balance,card_source,shop_member_system_id,transfer_flg,is_effective,source,activity_source,activity_id\nFROM card",
            "id":"fb543f81-441f-b9c9-c2b1-038efd556982",
            "name":"card",
            "position":{
                "x":847,
                "y":115
            },
            "tabid":"60",
            "type":"join"
        },
        {
            "dbid":"61",
            "extraSql":"SELECT id,mobile,phone,sex,birthday,certificate,spell,name,entity_id,is_valid,create_time,op_time,last_ver,contry_id,contry_code,consume_amount,last_consume_time,consume_num,extend_fields,country_code\nFROM customer",
            "id":"e53bc63e-f856-0982-c26b-d5935a326846",
            "name":"customer",
            "position":{
                "x":924,
                "y":115
            },
            "tabid":"61",
            "type":"join"
        },
        {
            "dbid":"62",
            "extraSql":"SELECT id,order_id,expense_id,approve_amount,head,order_time,shop_name,tax_id,invoice_status,invoice_record_id,ticket_type,paid_amount,enterprise_id,invoice_source,selected,invoice_id,can_invoice_amount,calculate_status,can_expense_amount,totalpay_id,invoice_type,expense_platform,trace_company,trace_number,invoice_address,invoice_preview_address,people_num,entity_id,attribute,create_time,last_ver,op_time,is_valid,type,status\nFROM ent_expense_order",
            "id":"c566823a-dd97-5322-788d-7b2178dc4100",
            "name":"ent_expense_order",
            "position":{
                "x":1026,
                "y":116
            },
            "tabid":"64",
            "type":"join"
        },
        {
            "dbid":"62",
            "extraSql":"SELECT id,staff_id,invoice_record_id,enterprise_id,customer_id,customer_name,mobile,expense_id,ticket_type,expense_type,paid_amount,apply_expense_amount,mutiple,approve_amount,approver_time,expense_status,approver,remark,attribute,create_time,last_ver,op_time,is_valid,type,status\nFROM ent_expense",
            "id":"ee32dc47-b03c-1c7e-be3f-d279ae1dc86d",
            "name":"ent_expense",
            "position":{
                "x":1153,
                "y":115
            },
            "tabid":"65",
            "type":"join"
        }
    ],
    "nodeMetas":[
        {
            "dependencies":[
                {
                    "id":"fb543f81-441f-b9c9-c2b1-038efd556982",
                    "name":"fb543f81-441f-b9c9-c2b1-038efd556982",
                    "type":"table"
                },
                {
                    "id":"e53bc63e-f856-0982-c26b-d5935a326846",
                    "name":"e53bc63e-f856-0982-c26b-d5935a326846",
                    "type":"table"
                }
            ],
            "exportName":"tmp_customer_card",
            "id":"615b3eb0-636c-535e-044a-0d8083d6036b",
            "position":{
                "x":825,
                "y":342
            },
            "sql":" SELECT cd.entity_id,cd.id,cd.code,cd.inner_code,cd.customer_id,c.name,c.spell,c.mobile,c.phone\n   , CASE WHEN regexp(cd.id,'^E_') THEN 1 ELSE 0 END AS is_enterprise_card\n  FROM card cd INNER JOIN customer c \n       ON (cd.customer_id = c.id AND cd.entity_id=c.entity_id ) ",
            "type":"join"
        },
        {
            "dependencies":[
                {
                    "id":"683deaa9-92c6-0022-1d27-40ba500077e5",
                    "name":"683deaa9-92c6-0022-1d27-40ba500077e5",
                    "type":"table"
                },
                {
                    "id":"d1fc10f7-b464-754c-be32-939b052ffcfd",
                    "name":"d1fc10f7-b464-754c-be32-939b052ffcfd",
                    "type":"table"
                },
                {
                    "id":"f168574b-6144-f6a8-d121-b4d01ea605c3",
                    "name":"f168574b-6144-f6a8-d121-b4d01ea605c3",
                    "type":"table"
                },
                {
                    "id":"615b3eb0-636c-535e-044a-0d8083d6036b",
                    "name":"615b3eb0-636c-535e-044a-0d8083d6036b",
                    "type":"table"
                },
                {
                    "id":"servicebillinfo",
                    "name":"servicebillinfo",
                    "type":"table"
                },
                {
                    "id":"6e7b9c50-0fba-8a19-f029-d973e5a833c7",
                    "name":"6e7b9c50-0fba-8a19-f029-d973e5a833c7",
                    "type":"table"
                },
                {
                    "id":"mall_shop",
                    "name":"mall_shop",
                    "type":"table"
                },
                {
                    "id":"5f7db367-d8a1-dd9f-8097-a37dc6606354",
                    "name":"5f7db367-d8a1-dd9f-8097-a37dc6606354",
                    "type":"table"
                }
            ],
            "exportName":"totalpay_summary",
            "id":"9f2752a8-d920-79c8-6ba5-31a74019ecb9",
            "position":{
                "x":699,
                "y":537
            },
            "sql":"SELECT tp.totalpay_id,tp.outfee,tp.curr_date,tp.source_amount,tp.discount_amount,tp.coupon_discount\n         ,tp.result_amount,tp.recieve_amount,tp.ratio,tp.status,tp.entity_id\n         ,tp.is_valid,tp.op_time,tp.last_ver,tp.op_user_id,tp.discount_plan_id\n         ,tp.operator,tp.operate_date,tp.card_id,tp.card,tp.card_entity_id\n         ,tp.is_full_ratio,tp.is_minconsume_ratio,tp.is_servicefee_ratio,tp.invoice_code\n         ,tp.invoice_memo,tp.invoice,tp.over_status,tp.is_hide,tp.load_time,tp.modify_time\n         ,o.order_id,o.seat_id,o.area_id,o.is_valido ,o.people_count \n         ,o.order_from \n         ,o.order_kind\n         ,o.inner_code\n         ,o.open_time\n         ,o.end_time\n         ,o.order_status\n         ,o.code , o.seat_code , o.customer_ids, o.has_fetch,o.customerregister_id\n         ,o.mobile AS order_mobile\n         ,o.address AS order_address\n         ,o.courier_phone\n         ,o.out_id\n         ,p.kindpay,p.fee as all_pay_fee,p.pay_customer_ids\n         ,sp.special_fee_summary\n         ,cc.code as card_code,cc.inner_code as card_inner_code,cc.customer_id as card_customer_id\n         ,cc.name as card_customer_name,cc.spell AS card_customer_spell\n         ,cc.mobile AS card_customer_moble\n         ,cc.phone AS card_customer_phone\n         ,o.bill_info_final_amount\n         ,sbill.final_amount AS service_bill_final_amount\n         , cd_exp.expense_status\n         , cd_exp.create_time as expense_create_time\n         , CASE WHEN (cc.is_enterprise_card > 0) OR (p.is_enterprise_card_pay >0) THEN 1 ELSE 0 END AS is_enterprise_card\n         , m.mall_entity_id AS mall_id\n         , tp.pt as ptt,tp.pmod\n FROM totalpayinfo tp INNER JOIN order_instance o ON (tp.totalpay_id = o.totalpay_id)\n     LEFT JOIN tmp_pay p ON (tp.totalpay_id = p.totalpay_id)\n                     LEFT JOIN tmp_group_specialfee sp ON( tp.totalpay_id = sp.totalpay_id AND tp.entity_id = sp.entity_id  )\n                     LEFT JOIN tmp_customer_card AS cc on(tp.card_id = cc.id AND tp.entity_id= cc.entity_id)\n                     LEFT JOIN servicebillinfo AS sbill on(tp.totalpay_id = sbill.servicebill_id AND sbill.is_valid=1)\n                     LEFT JOIN card_expense_relative AS cd_exp ON ( tp.totalpay_id = cd_exp.totalpay_id)\n                     LEFT JOIN mall_shop AS m ON (tp.entity_id = m.shop_entity_id AND m.is_valid=1 ) \n        WHERE tp.pt='20191101' and  cast(tp.curr_date as bigint) > 20191101",
            "type":"join"
        },
        {
            "dependencies":[
                {
                    "id":"e0245cb9-2e84-55b2-4e6f-f8c88bba4316",
                    "name":"e0245cb9-2e84-55b2-4e6f-f8c88bba4316",
                    "type":"table"
                }
            ],
            "exportName":"tmp_pay",
            "id":"5f7db367-d8a1-dd9f-8097-a37dc6606354",
            "position":{
                "x":687,
                "y":251
            },
            "sql":"SELECT aa.totalpay_id, concat_ws(';', collect_list(aa.aakindpay)) as kindpay\n  ,SUM(aa.fee) as fee\n  ,CASE WHEN sum(aa.is_enterprise_card_pay) >0 THEN 1 ELSE 0 END AS is_enterprise_card_pay\n  ,concat_ws(',',collect_list(aa.pay_customer_ids)) as pay_customer_ids\n  FROM (\n      SELECT \n           p.totalpay_id  \n         , SUM(p.fee) AS fee  \n         , concat_ws( '_', COALESCE( p.kindpay_id,'0')\n            , cast(count(1) AS STRING) \n            , cast(round(sum(p.fee),2) AS STRING)\n            , cast(\n               SUM(\n                 (COALESCE(p.coupon_fee,0) - COALESCE(p.coupon_cost,0)) * COALESCE(p.coupon_num, 0)\n              ) AS STRING)\n            , COALESCE( cast(min(p.pay_id) AS STRING),'0')\n          ) AS aakindpay\n         , SUM( CASE WHEN p.type = 103 THEN 1 ELSE 0 END ) AS is_enterprise_card_pay\n         , concat_ws(',', collect_list( get_json_object( p.ext, '$.customerRegisterId'))) AS pay_customer_ids\n      FROM payinfo as p\n      WHERE length(p.kindpay_id)> 0 AND p.is_valid=1\n      GROUP BY p.totalpay_id ,p.kindpay_id \n  ) AS aa\n  GROUP BY aa.totalpay_id",
            "type":"join"
        },
        {
            "dependencies":[
                {
                    "id":"c566823a-dd97-5322-788d-7b2178dc4100",
                    "name":"c566823a-dd97-5322-788d-7b2178dc4100",
                    "type":"table"
                },
                {
                    "id":"ee32dc47-b03c-1c7e-be3f-d279ae1dc86d",
                    "name":"ee32dc47-b03c-1c7e-be3f-d279ae1dc86d",
                    "type":"table"
                }
            ],
            "exportName":"card_expense_relative",
            "id":"6e7b9c50-0fba-8a19-f029-d973e5a833c7",
            "position":{
                "x":1059,
                "y":264
            },
            "sql":" SELECT a.totalpay_id , b.expense_status,a.create_time\n FROM ent_expense_order a \n    INNER JOIN ent_expense b \n    ON (a.expense_id = b.expense_id AND b.is_valid=1 AND a.is_valid=1 )",
            "type":"join"
        },
        {
            "dependencies":[
                {
                    "id":"a240c9ca-93da-6e79-6712-c7d2de4f2629",
                    "name":"a240c9ca-93da-6e79-6712-c7d2de4f2629",
                    "type":"table"
                }
            ],
            "exportName":"tmp_group_specialfee",
            "id":"f168574b-6144-f6a8-d121-b4d01ea605c3",
            "position":{
                "x":589,
                "y":253
            },
            "sql":"SELECT sf.entity_id,sf.totalpay_id\n       ,concat_ws( ';',collect_list(concat_ws( '_',cast(sf.kind AS STRING ) , cast(sf.fee AS STRING )  ))) AS special_fee_summary\n   FROM specialfee sf\n   WHERE sf.is_valid = 1\n   GROUP BY sf.entity_id, sf.totalpay_id",
            "type":"join"
        },
        {
            "dependencies":[
                {
                    "id":"f9e4a170-3f57-d541-b27e-b089ebf1ba75",
                    "name":"f9e4a170-3f57-d541-b27e-b089ebf1ba75",
                    "type":"table"
                }
            ],
            "exportName":"order_customers",
            "id":"edcac2da-9afd-6fc5-3489-d975fdb224f8",
            "position":{
                "x":509,
                "y":251
            },
            "sql":" SELECT a1.order_id, a1.customer_ids, COALESCE(a2.has_fetch, 0) has_fetch\n   FROM\n     (SELECT i.order_id, concat_ws(',',collect_set( split(i.batch_msg,'[\\\\w\\\\W]*\\\\|')[1])) as customer_ids\n     FROM instancedetail AS i\n     WHERE (  i.is_valid= 1 )\n     GROUP BY i.entity_id, i.order_id\n     ) a1\n   LEFT JOIN\n     (SELECT i.order_id, CASE WHEN SUM( OP_AND(i.draw_status,8)) > 0 THEN 1 ELSE 0 END as has_fetch\n      FROM instancedetail AS i\n     WHERE  ( i.is_valid= 1 AND i.status =2)\n     GROUP BY i.entity_id, i.order_id\n     ) a2\n   ON a1.order_id = a2.order_id",
            "type":"join"
        },
        {
            "dependencies":[
                {
                    "id":"d56d4423-33dc-2adc-c5a8-e26df611df77",
                    "name":"d56d4423-33dc-2adc-c5a8-e26df611df77",
                    "type":"table"
                },
                {
                    "id":"e6c9be82-d622-4e0f-db4e-f94df75518f3",
                    "name":"e6c9be82-d622-4e0f-db4e-f94df75518f3",
                    "type":"table"
                },
                {
                    "id":"edcac2da-9afd-6fc5-3489-d975fdb224f8",
                    "name":"edcac2da-9afd-6fc5-3489-d975fdb224f8",
                    "type":"table"
                }
            ],
            "exportName":"order_instance",
            "id":"d1fc10f7-b464-754c-be32-939b052ffcfd",
            "position":{
                "x":395,
                "y":369
            },
            "sql":" SELECT o.totalpay_id ,o.people_count, o.order_id, o.area_id ,o.seat_id ,o.mobile,o.address\n           ,o.is_valid AS is_valido , o.order_from , o.order_kind,o.open_time,o.end_time,o.order_status\n           ,o.inner_code ,o.code ,o.seat_code ,obill.final_amount AS bill_info_final_amount\n           ,ctm.customer_ids,ctm.has_fetch,o.customerregister_id , toe.courier_phone , toe.out_id\n     FROM  orderdetail o\n           LEFT JOIN order_bill AS obill on(o.order_id = obill.order_id AND obill.is_valid=1)\n           LEFT JOIN order_customers AS ctm ON (o.order_id = ctm.order_id)\n           LEFT JOIN takeout_order_extra AS toe \n             ON (o.order_id = toe.order_id  AND toe.courier_phone IS NOT NULL)\n    WHERE  o.is_valid=1",
            "type":"join"
        }
    ],
     "profile":{
         "dataflowId":180,
         "name":"totalpay",
         "timestamp":1614997404752
     }
 }
}